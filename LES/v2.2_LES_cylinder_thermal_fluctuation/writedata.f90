    SUBROUTINE WRITEDATA

	USE COMDAT_SHARED

	IMPLICIT NONE
	SAVE

    N=MOD(NITER_TIME,NITER_W)
    
    IF(N.EQ.0) THEN
	
	CONTOUR = 'YpOO_OO.PLT'
	
	WRITE(CONTOUR(3:4),'(I2.2)') INT(NUM_WRITE)
	
	WRITE(CONTOUR(6:7),'(I2.2)') INT(RANK)
	
	OPEN(UNIT=1000+RANK,FILE=CONTOUR,STATUS='UNKNOWN')
	WRITE(1000+RANK,*) 'TITLE="YPLUS"'
	WRITE(1000+RANK,*) 'variables="x","y","z","Yplus"'
	WRITE(1000+RANK,22) 1,JE1-JS1+1,KE1-KS1+1,RTIME
22	FORMAT(TR1,'ZONE T="POST", I=',I6,', j=',I6,', k=',I6,', SOLUTIONTIME=',F10.4)
	DO K=KS1,KE1
	DO J=JS1,JE1
	I=IS1
		WRITE(1000+RANK,27) X(I,J,K),Y(I,J,K),Z(I,J,K),YPLUS(I,J,K)
27		FORMAT(TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9)
	ENDDO
	ENDDO
	CLOSE(1000+RANK)
		
	CALL CALC_VOR ! VORTICITY POST-PROCESSING
		
	NUM_WRITE = NUM_WRITE + 1
	
	DO K=KS1,KE1
	DO J=JS1,JE1
	DO I=IS1,IE1
	DUDX=0.5D0*(XIX(I,J,K)*(U(I+1,J,K)-U(I-1,J,K))+ETX(I,J,K)*(U(I,J+1,K)-U(I,J-1,K))+ZTX(I,J,K)*(U(I,J,K+1)-U(I,J,K-1)))
	DVDX=0.5D0*(XIX(I,J,K)*(V(I+1,J,K)-V(I-1,J,K))+ETX(I,J,K)*(V(I,J+1,K)-V(I,J-1,K))+ZTX(I,J,K)*(V(I,J,K+1)-V(I,J,K-1)))
	DWDX=0.5D0*(XIX(I,J,K)*(W(I+1,J,K)-W(I-1,J,K))+ETX(I,J,K)*(W(I,J+1,K)-W(I,J-1,K))+ZTX(I,J,K)*(W(I,J,K+1)-W(I,J,K-1)))
	
	DUDY=0.5D0*(XIY(I,J,K)*(U(I+1,J,K)-U(I-1,J,K))+ETY(I,J,K)*(U(I,J+1,K)-U(I,J-1,K))+ZTY(I,J,K)*(U(I,J,K+1)-U(I,J,K-1)))
	DVDY=0.5D0*(XIY(I,J,K)*(V(I+1,J,K)-V(I-1,J,K))+ETY(I,J,K)*(V(I,J+1,K)-V(I,J-1,K))+ZTY(I,J,K)*(V(I,J,K+1)-V(I,J,K-1)))
	DWDY=0.5D0*(XIY(I,J,K)*(W(I+1,J,K)-W(I-1,J,K))+ETY(I,J,K)*(W(I,J+1,K)-W(I,J-1,K))+ZTY(I,J,K)*(W(I,J,K+1)-W(I,J,K-1)))
	
	DUDZ=0.5D0*(XIZ(I,J,K)*(U(I+1,J,K)-U(I-1,J,K))+ETZ(I,J,K)*(U(I,J+1,K)-U(I,J-1,K))+ZTZ(I,J,K)*(U(I,J,K+1)-U(I,J,K-1)))
	DVDZ=0.5D0*(XIZ(I,J,K)*(V(I+1,J,K)-V(I-1,J,K))+ETZ(I,J,K)*(V(I,J+1,K)-V(I,J-1,K))+ZTZ(I,J,K)*(V(I,J,K+1)-V(I,J,K-1)))
	DWDZ=0.5D0*(XIZ(I,J,K)*(W(I+1,J,K)-W(I-1,J,K))+ETZ(I,J,K)*(W(I,J+1,K)-W(I,J-1,K))+ZTZ(I,J,K)*(W(I,J,K+1)-W(I,J,K-1)))
	
!	SYMMETRIC PARTS OF THE VELOCITY GRADIENT TENSOR
	
	S1(1,1) = 0.5D0*(DUDX+DUDX)
	S1(2,1) = 0.5D0*(DVDX+DUDY)
	S1(3,1) = 0.5D0*(DWDX+DUDZ)
	
	S1(1,2) = 0.5D0*(DUDY+DVDX)
	S1(2,2) = 0.5D0*(DVDY+DVDY)
	S1(3,2) = 0.5D0*(DWDY+DVDZ)
	
	S1(1,3) = 0.5D0*(DUDZ+DWDX)
	S1(2,3) = 0.5D0*(DVDZ+DWDY)
	S1(3,3) = 0.5D0*(DWDZ+DWDZ)
	
	O1(1,1) = 0.5D0*(DUDX-DUDX)
	O1(2,1) = 0.5D0*(DVDX-DUDY)
	O1(3,1) = 0.5D0*(DWDX-DUDZ)
	
	O1(1,2) = 0.5D0*(DUDY-DVDX)
	O1(2,2) = 0.5D0*(DVDY-DVDY)
	O1(3,2) = 0.5D0*(DWDY-DVDZ)
	
	O1(1,3) = 0.5D0*(DUDZ-DWDX)
	O1(2,3) = 0.5D0*(DVDZ-DWDY)
	O1(3,3) = 0.5D0*(DWDZ-DWDZ)
	
	S2 = MATMUL(S1,S1)
	O2 = MATMUL(O1,O1)
		
!	S2(:,:) = 0.D0
!	O2(:,:) = 0.D0
!	
!	DO N=1,3
!	DO M=1,3
!	DO L=1,3
!		S2(M,N) = S2(M,N) + S1(L,N)*S1(M,L)
!		O2(M,N) = O2(M,N) + O1(L,N)*O1(M,L)
!	ENDDO
!	ENDDO
!	ENDDO
	
	S2O2(1:3,1:3) = S2(1:3,1:3) + O2(1:3,1:3)
	
	DUM_A = -1.D0
	DUM_B = +S2O2(1,1)+S2O2(2,2)+S2O2(3,3)
	DUM_C = -S2O2(1,1)*S2O2(2,2)-S2O2(2,2)*S2O2(3,3)-S2O2(3,3)*S2O2(1,1)	&
			+S2O2(1,2)*S2O2(2,1)+S2O2(2,3)*S2O2(3,2)+S2O2(3,1)*S2O2(1,3)
	DUM_D = +S2O2(1,1)*S2O2(2,2)*S2O2(3,3)+S2O2(1,2)*S2O2(2,3)*S2O2(3,1)+S2O2(1,3)*S2O2(2,1)*S2O2(3,2)	&
			-S2O2(1,1)*S2O2(2,3)*S2O2(3,2)-S2O2(2,2)*S2O2(1,3)*S2O2(3,1)-S2O2(3,3)*S2O2(1,2)*S2O2(2,1)
	
	CALL FIND_ROOT(DUM_A,DUM_B,DUM_C,DUM_D,LAMDA)
	
	LAMDA1 = MAX(LAMDA(1),LAMDA(2),LAMDA(3))
	LAMDA3 = MIN(LAMDA(1),LAMDA(2),LAMDA(3))
	
		DO N=1,3
			IF(LAMDA(N).LT.LAMDA1 .AND. LAMDA(N).GT.LAMDA3)	LAMDA2(I,J,K) = LAMDA(N)
		ENDDO
	
	ENDDO
	ENDDO
	ENDDO
	
	LAMDA2(IS,JS:JE,KS:KE) = 3.D0*LAMDA2(IS+1,JS:JE,KS:KE)-3.D0*LAMDA2(IS+2,JS:JE,KS:KE)+LAMDA2(IS+3,JS:JE,KS:KE)
	LAMDA2(IE,JS:JE,KS:KE) = 3.D0*LAMDA2(IE-1,JS:JE,KS:KE)-3.D0*LAMDA2(IE-2,JS:JE,KS:KE)+LAMDA2(IE-3,JS:JE,KS:KE)
	LAMDA2(IS:IE,JS,KS:KE) = 3.D0*LAMDA2(IS:IE,JS+1,KS:KE)-3.D0*LAMDA2(IS:IE,JS+2,KS:KE)+LAMDA2(IS:IE,JS+3,KS:KE)
	LAMDA2(IS:IE,JE,KS:KE) = 3.D0*LAMDA2(IS:IE,JE-1,KS:KE)-3.D0*LAMDA2(IS:IE,JE-2,KS:KE)+LAMDA2(IS:IE,JE-3,KS:KE)
	LAMDA2(IS:IE,JS:JE,KS) = 3.D0*LAMDA2(IS:IE,JS:JE,KS+1)-3.D0*LAMDA2(IS:IE,JS:JE,KS+2)+LAMDA2(IS:IE,JS:JE,KS+3)
	LAMDA2(IS:IE,JS:JE,KE) = 3.D0*LAMDA2(IS:IE,JS:JE,KE-1)-3.D0*LAMDA2(IS:IE,JS:JE,KE-2)+LAMDA2(IS:IE,JS:JE,KE-3)
	
	CALL MPI_X(LAMDA2)
	
	!   INTERPOLATION FOR NODAL RESULTS
	DO K=KS1,KE
	DO J=JS1,JE
	DO I=IS1,IE
		PG(I,J,K) = 0.125D0*(P(I,J,K)+P(I,J-1,K)+P(I-1,J,K)+P(I-1,J-1,K)		&
						+P(I,J,K-1)+P(I,J-1,K-1)+P(I-1,J,K-1)+P(I-1,J-1,K-1))
		UG(I,J,K) = 0.125D0*(U(I,J,K)+U(I,J-1,K)+U(I-1,J,K)+U(I-1,J-1,K)		&
						+U(I,J,K-1)+U(I,J-1,K-1)+U(I-1,J,K-1)+U(I-1,J-1,K-1))
		VG(I,J,K) = 0.125D0*(V(I,J,K)+V(I,J-1,K)+V(I-1,J,K)+V(I-1,J-1,K)		&
						+V(I,J,K-1)+V(I,J-1,K-1)+V(I-1,J,K-1)+V(I-1,J-1,K-1))
		WG(I,J,K) = 0.125D0*(W(I,J,K)+W(I,J-1,K)+W(I-1,J,K)+W(I-1,J-1,K)		&
						+W(I,J,K-1)+W(I,J-1,K-1)+W(I-1,J,K-1)+W(I-1,J-1,K-1))
		TG(I,J,K) = 0.125D0*(T(I,J,K)+T(I,J-1,K)+T(I-1,J,K)+T(I-1,J-1,K)		&
						+T(I,J,K-1)+T(I,J-1,K-1)+T(I-1,J,K-1)+T(I-1,J-1,K-1))
		DUM_3D(I,J,K) = 0.125D0*(VOR_M(I,J,K)+VOR_M(I,J-1,K)+VOR_M(I-1,J,K)+VOR_M(I-1,J-1,K)		&
						+VOR_M(I,J,K-1)+VOR_M(I,J-1,K-1)+VOR_M(I-1,J,K-1)+VOR_M(I-1,J-1,K-1))
		LAMDAG(I,J,K) = 0.125D0*(LAMDA2(I,J,K)+LAMDA2(I,J-1,K)+LAMDA2(I-1,J,K)+LAMDA2(I-1,J-1,K)	&
						+LAMDA2(I,J,K-1)+LAMDA2(I,J-1,K-1)+LAMDA2(I-1,J,K-1)+LAMDA2(I-1,J-1,K-1))
	ENDDO
	ENDDO
	ENDDO
	
	FILENAME = 'PVT_0000_00.PLT'

	WRITE(FILENAME(5:8),'(I4.4)') INT(NUM_WRITE)
	
	WRITE(FILENAME(10:11),'(I2.2)') INT(RANK)
	
	!   NODAL RESULTS
	OPEN(UNIT=1000+RANK,FILE=FILENAME,STATUS='UNKNOWN')
	WRITE(1000+RANK,*) 'TITLE="','RE',RE,'PR',PR,'"'
	WRITE(1000+RANK,*) 'variables=x,y,z,p,u,v,w,T'
    WRITE(1000+RANK,156) IE-IS,JE-JS,KE-KS,RTIME
156  FORMAT(TR1,'ZONE T="WHOLE", I=',I6,', J=',I6,', K=',I6,', SOLUTIONTIME=',F10.4)
	DO K=KS1,KE
    DO J=JS1,JE
    DO I=IS1,IE
		WRITE(1000+RANK,161) XG(I,J,K),YG(I,J,K),ZG(I,J,K),PG(I,J,K),UG(I,J,K),VG(I,J,K),WG(I,J,K),TG(I,J,K)
161		FORMAT(TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9)
	ENDDO
	ENDDO
	ENDDO
	CLOSE(1000+RANK)
	
	FILENAME = 'VOR_0000_00.PLT'

	WRITE(FILENAME(5:8),'(I4.4)') INT(NUM_WRITE)
	
	WRITE(FILENAME(10:11),'(I2.2)') INT(RANK)
	
	!   NODAL RESULTS
	OPEN(UNIT=100+RANK,FILE=FILENAME,STATUS='UNKNOWN')
	WRITE(100+RANK,*) 'TITLE="','RE',RE,'PR',PR,'"'
	WRITE(100+RANK,*) 'variables=x,y,z,vorM,lamda'
    WRITE(100+RANK,178) IE-IS,JE-JS,KE-KS,RTIME
178  FORMAT(TR1,'ZONE T="WHOLE", I=',I6,', J=',I6,', K=',I6,', SOLUTIONTIME=',F10.4)
	DO K=KS1,KE
    DO J=JS1,JE
    DO I=IS1,IE
		WRITE(100+RANK,183) XG(I,J,K),YG(I,J,K),ZG(I,J,K),DUM_3D(I,J,K),LAMDAG(I,J,K)
183		FORMAT(TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9,TR1,D16.9)
	ENDDO
	ENDDO
	ENDDO
	CLOSE(100+RANK)
	
	ENDIF ! IF(N.EQ.0) THEN
    
    !   RESTART FILE
    
    N=MOD(NITER_TIME,NITER_R)
    
    IF(N.EQ.0) THEN
    
    FILENAME2 = 'RESTART_OO.DAT'
	
	WRITE(FILENAME2(9:10),'(I2.2)') INT(RANK)
	
	OPEN(UNIT=16+RANK,FILE=FILENAME2,STATUS='UNKNOWN')
        WRITE(16+RANK,203) RE,PE,DTIME,RTIME,NITER_TIME
203		FORMAT(TR1,E24.16,TR1,E24.16,TR1,E24.16,TR1,E24.16,TR1,I16)
		DO K=KS,KE
		DO J=JS,JE
		DO I=IS,IE
		    WRITE(16+RANK,209) NLX(I,J,K),NLY(I,J,K),NLZ(I,J,K),ADV(I,J,K)
	    	WRITE(16+RANK,210) U(I,J,K),V(I,J,K),W(I,J,K),P(I,J,K),T(I,J,K)
209		FORMAT(TR1,E24.16,TR1,E24.16,TR1,E24.16,TR1,E24.16)
210		FORMAT(TR1,E24.16,TR1,E24.16,TR1,E24.16,TR1,E24.16,TR1,E24.16)
    	ENDDO
	    ENDDO
	    ENDDO
    CLOSE(16+RANK)
    	
    ENDIF	! IF(N.EQ.0) THEN

	END SUBROUTINE WRITEDATA